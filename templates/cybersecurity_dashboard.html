<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Crime Detection System</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            height: 100%;
            overflow-x: hidden;
            overflow-y: auto;
        }
        
        * {
            box-sizing: border-box;
        }
        
        .dashboard-container {
            min-height: 100vh;
            background: #f5f7fa;
            position: relative;
        }
        
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            width: 250px;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .sidebar h2 {
            margin-bottom: 30px;
            font-size: 1.5rem;
            text-align: center;
        }
        
        .nav-menu {
            list-style: none;
            padding: 0;
        }
        
        .nav-menu li {
            margin-bottom: 10px;
        }
        
        .nav-menu a {
            color: white;
            text-decoration: none;
            display: block;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .nav-menu a:hover, .nav-menu a.active {
            background: rgba(255,255,255,0.2);
            transform: translateX(5px);
        }
        
        .main-content {
            margin-left: 250px;
            padding: 20px 20px 60px 20px;
            min-height: 100vh;
            overflow-y: visible;
            width: calc(100% - 250px);
            box-sizing: border-box;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-title {
            font-size: 2rem;
            color: #2c3e50;
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 15px;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c3e50;
        }
        
        .threat-map {
            grid-column: 1 / -1;
            height: 400px;
        }
        
        #map {
            height: 100%;
            border-radius: 8px;
        }
        
        .filters-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        
        .filter-group label {
            margin-bottom: 5px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        
        .alerts-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .alert-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-left: 4px solid #e74c3c;
            background: #fdf2f2;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
        }
        
        .alert-item.medium {
            border-left-color: #f39c12;
            background: #fef9e7;
        }
        
        .alert-item.low {
            border-left-color: #27ae60;
            background: #eafaf1;
        }
        
        .alert-icon {
            margin-right: 15px;
            font-size: 1.2rem;
        }
        
        .alert-content {
            flex: 1;
        }
        
        .alert-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .alert-time {
            font-size: 0.8rem;
            color: #666;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-export {
            background: #8e44ad;
            color: white;
        }
        
        .btn-export:hover {
            background: #7d3c98;
        }
        
        /* Real-time Monitoring Styles */
        .threat-counter {
            background: #f44336;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        @keyframes flash {
            0%, 100% { background: #f44336; }
            50% { background: #ff9800; }
        }
        
        .threat-feed {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .threat-item {
            background: white;
            border-left: 4px solid #ddd;
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .threat-item.severity-critical {
            border-left-color: #d32f2f;
        }
        
        .threat-item.severity-high {
            border-left-color: #f57c00;
        }
        
        .threat-item.severity-medium {
            border-left-color: #fbc02d;
        }
        
        .threat-item.severity-low {
            border-left-color: #388e3c;
        }
        
        .threat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .threat-type {
            font-weight: bold;
            color: #333;
        }
        
        .threat-severity {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
            text-transform: uppercase;
        }
        
        .threat-severity.critical {
            background: #d32f2f;
        }
        
        .threat-severity.high {
            background: #f57c00;
        }
        
        .threat-severity.medium {
            background: #fbc02d;
            color: #333;
        }
        
        .threat-severity.low {
            background: #388e3c;
        }
        
        .threat-details {
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #666;
        }
        
        .threat-time {
            font-style: italic;
        }
        
        /* Health Metrics Styles */
        .health-metrics {
            display: grid;
            gap: 15px;
        }
        
        .health-item {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .health-label {
            min-width: 120px;
            font-weight: 500;
            color: #333;
        }
        
        .health-bar {
            flex: 1;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .health-progress {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }
        
        .health-progress.warning {
            background: linear-gradient(90deg, #ff9800, #ffc107);
        }
        
        .health-progress.danger {
            background: linear-gradient(90deg, #f44336, #e57373);
        }
        
        .health-value {
            min-width: 50px;
            text-align: right;
            font-weight: bold;
            color: #333;
        }
        
        /* Incident Timeline Styles */
        .incident-timeline {
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .incident-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #ddd;
        }
        
        .incident-item.critical {
            border-left-color: #d32f2f;
        }
        
        .incident-item.high {
            border-left-color: #f57c00;
        }
        
        .incident-item.medium {
            border-left-color: #fbc02d;
        }
        
        .incident-item.low {
            border-left-color: #388e3c;
        }
        
        .incident-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 18px;
            color: white;
        }
        
        .incident-content {
            flex: 1;
        }
        
        .incident-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 4px;
        }
        
        .incident-description {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 4px;
        }
        
        .incident-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8em;
            color: #999;
        }
        
        .incident-status {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            color: white;
        }
        
        .incident-status.open {
            background: #f44336;
        }
        
        .incident-status.investigating {
            background: #ff9800;
        }
        
        .incident-status.resolved {
             background: #4caf50;
         }
         
         /* Case Management Metrics Styles */
         .metrics-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
             gap: 20px;
             margin-bottom: 20px;
         }
         
         .metric-card {
             background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
             color: white;
             padding: 20px;
             border-radius: 12px;
             text-align: center;
             box-shadow: 0 4px 15px rgba(0,0,0,0.1);
             transition: transform 0.3s ease;
         }
         
         .metric-card:hover {
             transform: translateY(-5px);
         }
         
         .metric-value {
             font-size: 2.5em;
             font-weight: bold;
             margin-bottom: 8px;
         }
         
         .metric-label {
             font-size: 0.9em;
             opacity: 0.9;
             text-transform: uppercase;
             letter-spacing: 1px;
         }
         
         .outcomes-grid {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 30px;
         }
         
         .outcome-section {
             background: #f8f9fa;
             padding: 20px;
             border-radius: 8px;
         }
         
         .outcome-section h4 {
             margin-top: 0;
             margin-bottom: 15px;
             color: #333;
             text-align: center;
         }
         
         .performance-grid {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 30px;
         }
         
         .performance-section {
             background: #f8f9fa;
             padding: 20px;
             border-radius: 8px;
         }
         
         .performance-section h4 {
             margin-top: 0;
             margin-bottom: 15px;
             color: #333;
             text-align: center;
         }
         
         .officer-list {
             display: grid;
             gap: 12px;
         }
         
         .officer-item {
             background: white;
             padding: 15px;
             border-radius: 8px;
             border-left: 4px solid #2196f3;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
         
         .officer-name {
             font-weight: bold;
             color: #333;
             margin-bottom: 8px;
         }
         
         .officer-stats {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 10px;
             font-size: 0.9em;
             color: #666;
         }
         
         .officer-stat {
             display: flex;
             justify-content: space-between;
         }
         
         .department-stats {
             display: grid;
             gap: 15px;
         }
         
         .dept-stat-item {
             background: white;
             padding: 15px;
             border-radius: 8px;
             display: flex;
             justify-content: space-between;
             align-items: center;
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
         }
         
         .dept-stat-label {
             font-weight: 500;
             color: #333;
         }
         
         .dept-stat-value {
             font-weight: bold;
             color: #2196f3;
             font-size: 1.1em;
         }
        
        /* Enhanced Responsive Design */
        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .performance-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 992px) {
            .dashboard-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                position: fixed;
                top: 0;
                left: -250px;
                height: 100vh;
                z-index: 1000;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 15px;
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .user-info {
                justify-content: center;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .filters-panel {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                width: 100%;
            }
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1001;
            background: #667eea;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        /* Mobile Menu Backdrop */
        .mobile-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        
        .mobile-backdrop.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            .mobile-menu-toggle {
                display: block;
            }
            
            .sidebar {
                left: -250px;
                transition: left 0.3s ease;
            }
            
            .sidebar.active {
                left: 0;
            }
            
            .main-content {
                margin-left: 0;
                padding: 60px 10px 40px 10px;
                width: 100%;
                min-height: calc(100vh - 60px);
            }
            
            .dashboard-title {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .metric-card {
                padding: 15px;
            }
            
            .metric-value {
                font-size: 1.8rem;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .chart-container {
                padding: 15px;
            }
            
            .threat-feed {
                max-height: 200px;
            }
            
            .health-metrics {
                grid-template-columns: 1fr;
            }
            
            .case-metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .outcomes-grid {
                grid-template-columns: 1fr;
            }
            
            .performance-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-panel {
                padding: 15px;
            }
            
            .advanced-filters {
                padding: 15px;
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn-sm {
                width: 100%;
                text-align: center;
            }
        }
        
        @media (max-width: 480px) {
            .main-content {
                padding: 8px;
            }
            
            .dashboard-title {
                font-size: 1.3rem;
            }
            
            .metric-card {
                padding: 12px;
            }
            
            .metric-value {
                font-size: 1.5rem;
            }
            
            .metric-label {
                font-size: 0.8rem;
            }
            
            .chart-container {
                padding: 12px;
            }
            
            .user-info {
                flex-direction: column;
                gap: 8px;
            }
            
            .btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .threat-item {
                padding: 8px;
            }
            
            .incident-item {
                padding: 8px;
            }
            
            .health-metric {
                padding: 10px;
            }
            
            .drill-down-container {
                margin: 10px;
                border-radius: 6px;
            }
            
            .drill-down-header {
                padding: 12px;
            }
            
            .drill-down-content {
                padding: 15px;
                max-height: 300px;
            }
            
            .drill-down-item {
                padding: 10px;
            }
            
            .drill-down-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (hover: none) and (pointer: coarse) {
            .nav-link {
                padding: 15px 20px;
            }
            
            .btn {
                padding: 12px 20px;
                min-height: 44px;
            }
            
            .filter-tag .remove {
                padding: 5px;
                margin-left: 8px;
            }
            
            .clickable-chart {
                cursor: default;
            }
        }
        
        /* Print styles */
        @media print {
            .sidebar {
                display: none;
            }
            
            .main-content {
                margin-left: 0;
                padding: 0;
            }
            
            .dashboard-header {
                border-bottom: 2px solid #000;
                margin-bottom: 20px;
            }
            
            .btn {
                display: none;
            }
            
            .filters-panel {
                display: none;
            }
            
            .drill-down-container {
                display: none !important;
            }
            
            .chart-container {
                break-inside: avoid;
                margin-bottom: 20px;
            }
        }
        
        /* Advanced Filter Styles */
        .filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 0.8rem;
            border-radius: 4px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-sm:hover {
            background: #f8f9fa;
            border-color: #3498db;
        }
        
        .advanced-filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #e9ecef;
        }
        
        .custom-date-range {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .date-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .pattern-recognition {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #ddd;
        }
        
        .pattern-recognition h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1rem;
        }
        
        .pattern-options {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .pattern-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .active-filters {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        
        .active-filters-label {
            font-weight: bold;
            color: #2c3e50;
            margin-right: 10px;
        }
        
        .filter-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }
        
        .filter-tag {
            background: #3498db;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .filter-tag .remove:hover {
            color: #ff6b6b;
        }
        
        /* Drill-down Styles */
        .drill-down-container {
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .drill-down-header {
            background: #3498db;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .drill-down-content {
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .drill-down-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .drill-down-item:hover {
            background: #f8f9fa;
        }
        
        .drill-down-item:last-child {
            border-bottom: none;
        }
        
        .drill-down-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .drill-down-details {
            font-size: 0.9rem;
            color: #666;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }
        
        .clickable-chart {
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        
        .clickable-chart:hover {
            transform: scale(1.02);
        }
        
        /* Anomaly Detection Styles */
        .anomaly-indicator {
            position: relative;
        }
        
        .anomaly-indicator::after {
            content: '⚠️';
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            animation: pulse 2s infinite;
        }
        
        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }
        
        .trend-up {
            color: #27ae60;
        }
        
        .trend-down {
            color: #e74c3c;
        }
        
        .trend-stable {
            color: #f39c12;
        }
        
        /* Alerts Panel Styles */
        .alerts-panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .alerts-header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alerts-header h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .alerts-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alerts-container {
            max-height: 300px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .alert-item {
            background: #f8f9fa;
            border-left: 4px solid #ff6b6b;
            padding: 12px 15px;
            margin-bottom: 10px;
            border-radius: 0 5px 5px 0;
            transition: all 0.3s ease;
        }
        
        .alert-item:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }
        
        .alert-item.severity-high {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .alert-item.severity-medium {
            border-left-color: #ffc107;
            background: #fffbf0;
        }
        
        .alert-item.severity-low {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        
        .alert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .alert-title {
            font-weight: bold;
            color: #333;
        }
        
        .alert-time {
            font-size: 0.8rem;
            color: #666;
        }
        
        .alert-description {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        
        .alert-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .badge-danger {
            background: #dc3545;
            color: white;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* Create Alert Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
             resize: vertical;
             min-height: 80px;
         }
         
         /* Export Dropdown Styles */
         .export-dropdown {
             position: relative;
             display: inline-block;
         }
         
         .dropdown-menu {
             display: none;
             position: absolute;
             right: 0;
             top: 100%;
             background: white;
             border: 1px solid #ddd;
             border-radius: 5px;
             box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
             min-width: 180px;
             z-index: 1000;
         }
         
         .dropdown-menu.show {
             display: block;
         }
         
         .dropdown-menu a {
             display: block;
             padding: 10px 15px;
             color: #333;
             text-decoration: none;
             transition: background-color 0.3s ease;
         }
         
         .dropdown-menu a:hover {
             background-color: #f8f9fa;
         }
         
         .dropdown-menu a i {
             margin-right: 8px;
             width: 16px;
         }
         
         .dropdown-toggle .fa-chevron-down {
              margin-left: 5px;
              font-size: 0.8rem;
          }
          
          /* Chat Container Styles */
          .chat-container {
              max-height: 600px;
              display: flex;
              flex-direction: column;
          }
          
          .chat-header {
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              padding: 15px 20px;
              border-radius: 10px 10px 0 0;
              display: flex;
              justify-content: space-between;
              align-items: center;
          }
          
          .chat-header h3 {
              margin: 0;
              font-size: 1.1rem;
          }
          
          .chat-controls {
              display: flex;
              gap: 8px;
          }
          
          .chat-controls .btn {
              padding: 6px 12px;
              font-size: 0.8rem;
              background: rgba(255, 255, 255, 0.2);
              border: 1px solid rgba(255, 255, 255, 0.3);
              color: white;
              border-radius: 5px;
              transition: all 0.3s ease;
          }
          
          .chat-controls .btn:hover {
              background: rgba(255, 255, 255, 0.3);
          }
          
          .chat-body {
              background: white;
              border-radius: 0 0 10px 10px;
              flex: 1;
              display: flex;
              flex-direction: column;
              max-height: 500px;
          }
          
          .chat-participants {
              background: #f8f9fa;
              padding: 10px 15px;
              border-bottom: 1px solid #e9ecef;
              display: flex;
              gap: 15px;
              flex-wrap: wrap;
          }
          
          .participant {
              background: #e9ecef;
              padding: 5px 10px;
              border-radius: 15px;
              font-size: 0.8rem;
              display: flex;
              align-items: center;
              gap: 5px;
              transition: all 0.3s ease;
          }
          
          .participant.active {
              background: #28a745;
              color: white;
          }
          
          .participant.typing {
              background: #ffc107;
              color: #212529;
          }
          
          .chat-messages {
              flex: 1;
              padding: 15px;
              overflow-y: auto;
              max-height: 300px;
              min-height: 200px;
          }
          
          .message {
              margin-bottom: 15px;
              display: flex;
              flex-direction: column;
          }
          
          .message.own {
              align-items: flex-end;
          }
          
          .message.other {
              align-items: flex-start;
          }
          
          .message-header {
              font-size: 0.75rem;
              color: #6c757d;
              margin-bottom: 3px;
          }
          
          .message-content {
              background: #e9ecef;
              padding: 10px 15px;
              border-radius: 15px;
              max-width: 70%;
              word-wrap: break-word;
          }
          
          .message.own .message-content {
              background: #007bff;
              color: white;
          }
          
          .message.priority .message-content {
              background: #dc3545;
              color: white;
              border-left: 4px solid #c82333;
          }
          
          .message.status-update .message-content {
              background: #28a745;
              color: white;
              border-left: 4px solid #1e7e34;
          }
          
          .system-message {
              text-align: center;
              color: #6c757d;
              font-style: italic;
              margin: 10px 0;
              padding: 10px;
              background: #f8f9fa;
              border-radius: 10px;
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
          }
          
          .chat-input-area {
              border-top: 1px solid #e9ecef;
              padding: 15px;
          }
          
          .chat-input-wrapper {
              display: flex;
              gap: 10px;
              margin-bottom: 10px;
          }
          
          .chat-input-wrapper input {
              flex: 1;
              padding: 10px 15px;
              border: 1px solid #ddd;
              border-radius: 25px;
              outline: none;
              font-size: 0.9rem;
          }
          
          .chat-input-wrapper input:focus {
              border-color: #007bff;
              box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
          }
          
          .chat-input-wrapper .btn {
              padding: 10px 15px;
              border-radius: 50%;
              background: #007bff;
              border: none;
              color: white;
              cursor: pointer;
              transition: all 0.3s ease;
          }
          
          .chat-input-wrapper .btn:hover {
              background: #0056b3;
              transform: scale(1.05);
          }
          
          .chat-features {
              display: flex;
              gap: 8px;
              justify-content: center;
          }
          
          .feature-btn {
              background: #f8f9fa;
              border: 1px solid #dee2e6;
              padding: 8px 12px;
              border-radius: 5px;
              cursor: pointer;
              transition: all 0.3s ease;
              color: #495057;
          }
          
          .feature-btn:hover {
              background: #e9ecef;
              color: #007bff;
          }
          
          .typing-indicator {
              display: none;
              color: #6c757d;
              font-style: italic;
              padding: 5px 15px;
          }
          
          .typing-indicator.show {
              display: block;
          }
          
          @media (max-width: 768px) {
              .chat-container {
                  max-height: 400px;
              }
              
              .chat-messages {
                  max-height: 200px;
              }
              
              .chat-participants {
                  flex-direction: column;
                  gap: 8px;
              }
              
              .message-content {
                   max-width: 85%;
               }
           }
           
           /* Advanced Features Styles */
           .advanced-features-grid {
               display: grid;
               grid-template-columns: 1fr 1fr 1fr;
               gap: 20px;
               margin-bottom: 30px;
           }
           
           .feature-panel {
               background: white;
               border-radius: 12px;
               box-shadow: 0 2px 10px rgba(0,0,0,0.1);
               overflow: hidden;
           }
           
           .panel-header {
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               color: white;
               padding: 15px 20px;
               display: flex;
               justify-content: space-between;
               align-items: center;
           }
           
           .panel-header h3 {
               margin: 0;
               font-size: 1rem;
           }
           
           .panel-controls {
               display: flex;
               gap: 8px;
           }
           
           .panel-controls .btn,
           .panel-controls select {
               padding: 4px 8px;
               font-size: 0.75rem;
               background: rgba(255, 255, 255, 0.2);
               border: 1px solid rgba(255, 255, 255, 0.3);
               color: white;
               border-radius: 4px;
           }
           
           /* Activity Feed Styles */
           .activity-list {
               max-height: 300px;
               overflow-y: auto;
               padding: 15px;
           }
           
           .activity-item {
               display: flex;
               align-items: center;
               gap: 12px;
               padding: 10px 0;
               border-bottom: 1px solid #f0f0f0;
           }
           
           .activity-item:last-child {
               border-bottom: none;
           }
           
           .activity-icon {
               width: 32px;
               height: 32px;
               border-radius: 50%;
               display: flex;
               align-items: center;
               justify-content: center;
               color: white;
               font-size: 0.8rem;
           }
           
           .activity-icon.success {
               background: #28a745;
           }
           
           .activity-icon.warning {
               background: #ffc107;
               color: #212529;
           }
           
           .activity-icon.info {
               background: #17a2b8;
           }
           
           .activity-icon.error {
               background: #dc3545;
           }
           
           .activity-content {
               flex: 1;
           }
           
           .activity-title {
               font-weight: 500;
               color: #333;
               margin-bottom: 2px;
           }
           
           .activity-time {
               font-size: 0.75rem;
               color: #666;
           }
           
           /* Analytics Panel Styles */
           .analytics-content {
               padding: 15px;
           }
           
           .analytics-metric {
               display: flex;
               align-items: center;
               gap: 12px;
               padding: 12px 0;
               border-bottom: 1px solid #f0f0f0;
           }
           
           .analytics-metric:last-child {
               border-bottom: none;
           }
           
           .analytics-metric .metric-icon {
               width: 40px;
               height: 40px;
               background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
               border-radius: 8px;
               display: flex;
               align-items: center;
               justify-content: center;
               color: white;
           }
           
           .metric-info {
               flex: 1;
           }
           
           .metric-value {
               font-size: 1.2rem;
               font-weight: bold;
               color: #333;
           }
           
           .metric-label {
               font-size: 0.8rem;
               color: #666;
               margin-bottom: 2px;
           }
           
           .metric-trend {
               font-size: 0.75rem;
               font-weight: 500;
           }
           
           .metric-trend.up {
               color: #28a745;
           }
           
           .metric-trend.down {
               color: #dc3545;
           }
           
           /* Quick Actions Styles */
           .actions-grid {
               display: grid;
               grid-template-columns: 1fr 1fr;
               gap: 10px;
               padding: 15px;
           }
           
           .action-btn {
               background: #f8f9fa;
               border: 1px solid #dee2e6;
               border-radius: 8px;
               padding: 15px 10px;
               cursor: pointer;
               transition: all 0.3s ease;
               display: flex;
               flex-direction: column;
               align-items: center;
               gap: 8px;
               text-align: center;
           }
           
           .action-btn:hover {
               background: #e9ecef;
               transform: translateY(-2px);
               box-shadow: 0 4px 8px rgba(0,0,0,0.1);
           }
           
           .action-btn.emergency {
               background: #fff5f5;
               border-color: #fed7d7;
               color: #c53030;
           }
           
           .action-btn.emergency:hover {
               background: #fed7d7;
           }
           
           .action-btn i {
               font-size: 1.2rem;
           }
           
           .action-btn span {
               font-size: 0.8rem;
               font-weight: 500;
           }
           
           @media (max-width: 1200px) {
               .advanced-features-grid {
                   grid-template-columns: 1fr 1fr;
               }
           }
           
           @media (max-width: 768px) {
               .advanced-features-grid {
                   grid-template-columns: 1fr;
               }
               
               .actions-grid {
                   grid-template-columns: 1fr;
               }
           }
    </style>
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Mobile Menu Backdrop -->
    <div class="mobile-backdrop" onclick="closeMobileMenu()"></div>
    
    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <h2><i class="fas fa-shield-alt"></i> Security Hub</h2>
            <ul class="nav-menu">
                <li><a href="#overview" class="nav-link active"><i class="fas fa-tachometer-alt"></i> Overview</a></li>
                <li><a href="#threats" class="nav-link"><i class="fas fa-exclamation-triangle"></i> Threat Monitor</a></li>
                <li><a href="#cases" class="nav-link"><i class="fas fa-folder-open"></i> Case Management</a></li>
                <li><a href="#analytics" class="nav-link"><i class="fas fa-chart-line"></i> Analytics</a></li>
                <li><a href="#alerts" class="nav-link"><i class="fas fa-bell"></i> Alerts</a></li>
                <li><a href="{{ url_for('original_home') }}"><i class="fas fa-home"></i> Main System</a></li>
                <li><a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <h1 class="dashboard-title">Dashboard</h1>
                <div class="user-info">
                    <span>Welcome, {{ session.admin_username }}</span>
                    <span class="badge">{{ data.admin_role.title() }}</span>
                    {% if has_permission('export_reports') %}
                    <div class="export-dropdown">
                        <button class="btn btn-export dropdown-toggle" onclick="toggleExportMenu()"><i class="fas fa-download"></i> Export Report <i class="fas fa-chevron-down"></i></button>
                        <div id="export-menu" class="dropdown-menu">
                            <a href="#" onclick="exportDashboard('threats')"><i class="fas fa-shield-alt"></i> Threat Data</a>
                            <a href="#" onclick="exportDashboard('cases')"><i class="fas fa-folder-open"></i> Case Data</a>
                            <a href="#" onclick="exportDashboard('full')"><i class="fas fa-file-alt"></i> Full Report</a>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Advanced Filters Panel -->
            <div class="filters-panel">
                <div class="filter-header">
                    <h3><i class="fas fa-filter"></i> Advanced Data Filters</h3>
                    <div class="filter-controls">
                        {% if has_permission('advanced_filters') %}
                        <button class="btn btn-sm" onclick="toggleAdvancedFilters()">Advanced</button>
                        {% endif %}
                        <button class="btn btn-sm" onclick="resetAllFilters()">Reset</button>
                        {% if has_permission('save_filter_presets') %}
                        <button class="btn btn-sm" onclick="saveFilterPreset()">Save Preset</button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Basic Filters -->
                <div class="filters-grid basic-filters">
                    <div class="filter-group">
                        <label for="timeRange">Time Range</label>
                        <select id="timeRange" onchange="applyFilters()">
                            <option value="1h">Last Hour</option>
                            <option value="24h">Last 24 Hours</option>
                            <option value="7d">Last 7 Days</option>
                            <option value="30d" selected>Last 30 Days</option>
                            <option value="90d">Last 90 Days</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="threatType">Threat Type</label>
                        <select id="threatType" onchange="applyFilters()" multiple>
                            <option value="all" selected>All Types</option>
                            <option value="malware">Malware</option>
                            <option value="phishing">Phishing</option>
                            <option value="ddos">DDoS Attack</option>
                            <option value="intrusion">Intrusion</option>
                            <option value="data_breach">Data Breach</option>
                            <option value="ransomware">Ransomware</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="severity">Severity Level</label>
                        <select id="severity" onchange="applyFilters()" multiple>
                            <option value="all" selected>All Levels</option>
                            <option value="critical">Critical</option>
                            <option value="high">High</option>
                            <option value="medium">Medium</option>
                            <option value="low">Low</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="status">Case Status</label>
                        <select id="status" onchange="applyFilters()" multiple>
                            <option value="all" selected>All Status</option>
                            <option value="new">New</option>
                            <option value="active">Active</option>
                            <option value="investigating">Investigating</option>
                            <option value="resolved">Resolved</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                
                <!-- Advanced Filters (Initially Hidden) -->
                <div id="advanced-filters" class="advanced-filters" style="display: none;">
                    <div class="filters-grid">
                        <div class="filter-group">
                            <label for="geographic">Geographic Region</label>
                            <select id="geographic" onchange="applyFilters()" multiple>
                                <option value="all" selected>All Regions</option>
                                <option value="north_america">North America</option>
                                <option value="europe">Europe</option>
                                <option value="asia">Asia Pacific</option>
                                <option value="south_america">South America</option>
                                <option value="africa">Africa</option>
                                <option value="oceania">Oceania</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="source">Attack Source</label>
                            <select id="source" onchange="applyFilters()" multiple>
                                <option value="all" selected>All Sources</option>
                                <option value="external">External</option>
                                <option value="internal">Internal</option>
                                <option value="unknown">Unknown</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="officer">Assigned Officer</label>
                            <select id="officer" onchange="applyFilters()">
                                <option value="all">All Officers</option>
                                <option value="smith">Officer Smith</option>
                                <option value="johnson">Officer Johnson</option>
                                <option value="williams">Officer Williams</option>
                                <option value="brown">Officer Brown</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="priority">Priority Level</label>
                            <select id="priority" onchange="applyFilters()" multiple>
                                <option value="all" selected>All Priorities</option>
                                <option value="urgent">Urgent</option>
                                <option value="high">High</option>
                                <option value="normal">Normal</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Custom Date Range -->
                    <div id="custom-date-range" class="custom-date-range" style="display: none;">
                        <div class="date-inputs">
                            <div class="filter-group">
                                <label for="startDate">Start Date</label>
                                <input type="datetime-local" id="startDate" onchange="applyFilters()">
                            </div>
                            <div class="filter-group">
                                <label for="endDate">End Date</label>
                                <input type="datetime-local" id="endDate" onchange="applyFilters()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pattern Recognition -->
                    <div class="pattern-recognition">
                        <h4><i class="fas fa-brain"></i> Pattern Recognition</h4>
                        <div class="pattern-options">
                            <label><input type="checkbox" id="anomalyDetection" onchange="applyFilters()"> Detect Anomalies</label>
                            <label><input type="checkbox" id="trendAnalysis" onchange="applyFilters()"> Trend Analysis</label>
                            <label><input type="checkbox" id="correlationAnalysis" onchange="applyFilters()"> Correlation Analysis</label>
                        </div>
                    </div>
                </div>
                
                <!-- Active Filters Display -->
                <div id="active-filters" class="active-filters">
                    <span class="active-filters-label">Active Filters:</span>
                    <div id="filter-tags" class="filter-tags"></div>
                </div>
            </div>
            
            <!-- Security Alerts Panel -->
            {% if has_permission('view_alerts') %}
            <div class="alerts-panel">
                <div class="alerts-header">
                    <h3><i class="fas fa-exclamation-triangle"></i> Security Alerts</h3>
                    <div class="alerts-controls">
                        <span id="alerts-count" class="badge badge-danger">0</span>
                        <button class="btn btn-sm" onclick="refreshAlerts()"><i class="fas fa-sync"></i> Refresh</button>
                        {% if has_permission('create_alerts') %}
                        <button class="btn btn-sm btn-primary" onclick="showCreateAlert()"><i class="fas fa-plus"></i> Create Alert</button>
                        {% endif %}
                    </div>
                </div>
                <div id="alerts-container" class="alerts-container">
                    <div class="loading-spinner">Loading alerts...</div>
                </div>
            </div>
            {% endif %}
            
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-value" id="totalCriminals">{{ data.total_criminals }}</div>
                    <div class="stat-label">Total Criminals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="stat-value" id="activeThreats">0</div>
                    <div class="stat-label">Active Threats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <i class="fas fa-folder-open"></i>
                    </div>
                    <div class="stat-value" id="activeCases">0</div>
                    <div class="stat-label">Active Cases</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-value" id="completionRate">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
            </div>
            
            <!-- Advanced Features Grid -->
            <div class="advanced-features-grid">
                <!-- Real-time Activity Feed -->
                <div class="feature-panel activity-feed">
                    <div class="panel-header">
                        <h3><i class="fas fa-stream"></i> Real-time Activity Feed</h3>
                        <div class="panel-controls">
                            <button class="btn btn-sm" onclick="pauseActivityFeed()" id="pause-feed-btn">
                                <i class="fas fa-pause"></i> Pause
                            </button>
                            <button class="btn btn-sm" onclick="clearActivityFeed()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    <div class="activity-list" id="activity-list">
                        <div class="activity-item">
                            <div class="activity-icon success"><i class="fas fa-check"></i></div>
                            <div class="activity-content">
                                <div class="activity-title">Case #2024-001 resolved</div>
                                <div class="activity-time">2 minutes ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon warning"><i class="fas fa-exclamation-triangle"></i></div>
                            <div class="activity-content">
                                <div class="activity-title">New threat detected in Zone A</div>
                                <div class="activity-time">5 minutes ago</div>
                            </div>
                        </div>
                        <div class="activity-item">
                            <div class="activity-icon info"><i class="fas fa-user-plus"></i></div>
                            <div class="activity-content">
                                <div class="activity-title">New suspect registered</div>
                                <div class="activity-time">8 minutes ago</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Analytics Panel -->
                <div class="feature-panel analytics-panel">
                    <div class="panel-header">
                        <h3><i class="fas fa-chart-pie"></i> Enhanced Analytics</h3>
                        <div class="panel-controls">
                            <select id="analytics-timeframe" onchange="updateAnalytics()">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                                <option value="90d">Last 90 Days</option>
                            </select>
                        </div>
                    </div>
                    <div class="analytics-content">
                        <div class="analytics-metric">
                            <div class="metric-icon"><i class="fas fa-tachometer-alt"></i></div>
                            <div class="metric-info">
                                <div class="metric-value" id="response-time">2.3s</div>
                                <div class="metric-label">Avg Response Time</div>
                                <div class="metric-trend up">↗ 12%</div>
                            </div>
                        </div>
                        <div class="analytics-metric">
                            <div class="metric-icon"><i class="fas fa-bullseye"></i></div>
                            <div class="metric-info">
                                <div class="metric-value" id="accuracy-rate">94.7%</div>
                                <div class="metric-label">Detection Accuracy</div>
                                <div class="metric-trend up">↗ 3%</div>
                            </div>
                        </div>
                        <div class="analytics-metric">
                            <div class="metric-icon"><i class="fas fa-shield-alt"></i></div>
                            <div class="metric-info">
                                <div class="metric-value" id="threat-prevention">87</div>
                                <div class="metric-label">Threats Prevented</div>
                                <div class="metric-trend up">↗ 23%</div>
                            </div>
                        </div>
                        <div class="analytics-metric">
                            <div class="metric-icon"><i class="fas fa-clock"></i></div>
                            <div class="metric-info">
                                <div class="metric-value" id="case-resolution">4.2h</div>
                                <div class="metric-label">Avg Case Resolution</div>
                                <div class="metric-trend down">↘ 8%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions Panel -->
                <div class="feature-panel quick-actions">
                    <div class="panel-header">
                        <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                    </div>
                    <div class="actions-grid">
                        <button class="action-btn emergency" onclick="triggerEmergencyAlert()">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span>Emergency Alert</span>
                        </button>
                        <button class="action-btn" onclick="generateReport()">
                            <i class="fas fa-file-alt"></i>
                            <span>Generate Report</span>
                        </button>
                        <button class="action-btn" onclick="backupData()">
                            <i class="fas fa-database"></i>
                            <span>Backup Data</span>
                        </button>
                        <button class="action-btn" onclick="systemMaintenance()">
                            <i class="fas fa-tools"></i>
                            <span>Maintenance</span>
                        </button>
                        <button class="action-btn" onclick="exportAllData()">
                            <i class="fas fa-download"></i>
                            <span>Export All</span>
                        </button>
                        <button class="action-btn" onclick="scheduleTask()">
                            <i class="fas fa-calendar-plus"></i>
                            <span>Schedule Task</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Charts Grid -->
            <div class="charts-grid">
                <div class="chart-container">
                    <div class="chart-title">Threat Distribution</div>
                    <canvas id="threatChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Case Status Overview</div>
                    <canvas id="caseChart" width="400" height="200"></canvas>
                </div>
                <div class="chart-container threat-map">
                    <div class="chart-title">Threat Heatmap</div>
                    <div id="map"></div>
                </div>
                
                <!-- Real-time Threat Map -->
                <div class="chart-container">
                    <h3>Global Threat Distribution</h3>
                    <div id="threat-heatmap" style="height: 400px;"></div>
                </div>
                
                <!-- Live Threat Feed -->
                <div class="chart-container">
                    <h3>Live Threat Feed <span id="threat-counter" class="threat-counter">0</span></h3>
                    <div id="threat-feed" class="threat-feed"></div>
                </div>
                
                <!-- System Health Metrics -->
                <div class="chart-container">
                    <h3>System Health</h3>
                    <div id="system-health" class="health-metrics">
                        <div class="health-item">
                            <span class="health-label">CPU Usage</span>
                            <div class="health-bar">
                                <div id="cpu-bar" class="health-progress"></div>
                            </div>
                            <span id="cpu-value" class="health-value">0%</span>
                        </div>
                        <div class="health-item">
                            <span class="health-label">Memory Usage</span>
                            <div class="health-bar">
                                <div id="memory-bar" class="health-progress"></div>
                            </div>
                            <span id="memory-value" class="health-value">0%</span>
                        </div>
                        <div class="health-item">
                            <span class="health-label">Disk Usage</span>
                            <div class="health-bar">
                                <div id="disk-bar" class="health-progress"></div>
                            </div>
                            <span id="disk-value" class="health-value">0%</span>
                        </div>
                        <div class="health-item">
                            <span class="health-label">Network Traffic</span>
                            <div class="health-bar">
                                <div id="network-bar" class="health-progress"></div>
                            </div>
                            <span id="network-value" class="health-value">0%</span>
                        </div>
                    </div>
                </div>
                
                <!-- Incident Timeline -->
                 <div class="chart-container">
                     <h3>Recent Incidents</h3>
                     <div id="incident-timeline" class="incident-timeline"></div>
                 </div>
                 
                 <!-- Case Management Metrics -->
                 <div class="chart-container">
                     <h3>Case Management Overview</h3>
                     <div class="metrics-grid">
                         <div class="metric-card">
                             <div class="metric-value" id="total-cases">0</div>
                             <div class="metric-label">Total Cases</div>
                         </div>
                         <div class="metric-card">
                             <div class="metric-value" id="active-cases">0</div>
                             <div class="metric-label">Active Cases</div>
                         </div>
                         <div class="metric-card">
                             <div class="metric-value" id="resolved-cases">0</div>
                             <div class="metric-label">Resolved Cases</div>
                         </div>
                         <div class="metric-card">
                             <div class="metric-value" id="completion-rate">0%</div>
                             <div class="metric-label">Completion Rate</div>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Case Status Distribution -->
                 <div class="chart-container">
                     <h3>Case Status Distribution</h3>
                     <canvas id="case-status-chart"></canvas>
                 </div>
                 

                 <!-- Monthly Trends -->
                 <div class="chart-container">
                     <h3>Monthly Case Trends</h3>
                     <canvas id="monthly-trends-chart"></canvas>
                 </div>
                 
                 <!-- Investigation Outcomes -->
                 <div class="chart-container">
                     <h3>Investigation Outcomes</h3>
                     <div class="outcomes-grid">
                         <div class="outcome-section">
                             <h4>Resolution Types</h4>
                             <canvas id="resolution-types-chart"></canvas>
                         </div>
                         <div class="outcome-section">
                             <h4>Investigation Methods</h4>
                             <canvas id="investigation-methods-chart"></canvas>
                         </div>
                     </div>
                 </div>
                 
                 <!-- Performance Analytics -->
                 <div class="chart-container">
                     <h3>Performance Analytics</h3>
                     <div class="performance-grid">
                         <div class="performance-section">
                             <h4>Officer Performance</h4>
                             <div id="officer-performance" class="officer-list"></div>
                         </div>
                         <div class="performance-section">
                             <h4>Department Metrics</h4>
                             <div id="department-metrics" class="department-stats"></div>
                         </div>
                     </div>
                 </div>
             </div>
            
            <!-- Alerts Panel -->
            <div class="alerts-panel">
                <h3><i class="fas fa-bell"></i> Recent Alerts</h3>
                <div id="alertsList">
                    <!-- Alerts will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Drill-down Container -->
    <div id="drill-down-container" class="drill-down-container" style="display: none;">
        <div class="drill-down-header">
            <h3>Detailed Information</h3>
            <button onclick="closeDrillDown()" class="btn btn-sm">&times;</button>
        </div>
        <div id="drill-down-content" class="drill-down-content">
            <!-- Drill-down content will be populated here -->
        </div>
    </div>

    <script>
        let map;
        let threatChart;
        let caseChart;
        let dashboardData = {};
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            loadDashboardData();
            setupNavigation();
            
            // Initialize real-time monitoring
            initializeRealTimeMonitoring();
            
            // Auto-refresh data every 30 seconds
            setInterval(updateDashboard, 30000);
            
            // Real-time threat updates every 10 seconds
            setInterval(updateRealTimeThreats, 10000);
            
            // Enable drill-down on charts
            const chartElements = document.querySelectorAll('.chart-container');
            chartElements.forEach(chart => {
                const chartType = chart.id.includes('threat') ? 'threats' : 'cases';
                enableDrillDown(chart, chartType);
            });
            
            // Set up custom date range toggle
            const timeRangeElement = document.getElementById('time-range');
            if (timeRangeElement) {
                timeRangeElement.addEventListener('change', function() {
                    const customDateRange = document.getElementById('custom-date-range');
                    if (customDateRange) {
                        customDateRange.style.display = this.value === 'custom' ? 'block' : 'none';
                    }
                });
            }
            
            // Initialize alerts
            refreshAlerts();
            
            // Initialize advanced features
            initializeAdvancedFeatures();
        });
        
        // Initialize Leaflet map
        function initializeMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                const [threatsResponse, casesResponse] = await Promise.all([
                    fetch('/api/dashboard/threats'),
                    fetch('/api/dashboard/cases')
                ]);
                
                const threats = await threatsResponse.json();
                const cases = await casesResponse.json();
                
                dashboardData = { threats: threats.threats, cases };
                
                updateStatistics();
                updateCharts();
                updateMap();
                updateAlerts();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }
        
        // Update statistics cards
        function updateStatistics() {
            const activeThreats = dashboardData.threats.filter(t => t.status === 'Active').length;
            document.getElementById('activeThreats').textContent = activeThreats;
            document.getElementById('activeCases').textContent = dashboardData.cases.in_progress || 0;
            document.getElementById('completionRate').textContent = dashboardData.cases.completion_rate + '%';
        }
        
        // Update charts
        function updateCharts() {
            updateThreatChart();
            updateCaseChart();
        }
        
        // Update threat distribution chart
        function updateThreatChart() {
            const ctx = document.getElementById('threatChart').getContext('2d');
            
            const threatTypes = {};
            dashboardData.threats.forEach(threat => {
                threatTypes[threat.type] = (threatTypes[threat.type] || 0) + 1;
            });
            
            if (threatChart) threatChart.destroy();
            
            threatChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(threatTypes),
                    datasets: [{
                        data: Object.values(threatTypes),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0',
                            '#9966FF'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Update case status chart
        function updateCaseChart() {
            const ctx = document.getElementById('caseChart').getContext('2d');
            
            if (caseChart) caseChart.destroy();
            
            caseChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['New', 'In Progress', 'Resolved'],
                    datasets: [{
                        label: 'Cases',
                        data: [
                            dashboardData.cases.new_cases,
                            dashboardData.cases.in_progress,
                            dashboardData.cases.resolved
                        ],
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#4BC0C0'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        // Update threat map
        function updateMap() {
            // Clear existing markers
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            // Add threat markers
            dashboardData.threats.forEach(threat => {
                const color = getSeverityColor(threat.severity);
                const marker = L.circleMarker([threat.location.lat, threat.location.lng], {
                    color: color,
                    fillColor: color,
                    fillOpacity: 0.7,
                    radius: getSeverityRadius(threat.severity)
                }).addTo(map);
                
                marker.bindPopup(`
                    <strong>${threat.type}</strong><br>
                    Severity: ${threat.severity}<br>
                    Status: ${threat.status}<br>
                    Location: ${threat.location.city}
                `);
            });
        }
        
        // Get severity color
        function getSeverityColor(severity) {
            const colors = {
                'Critical': '#e74c3c',
                'High': '#f39c12',
                'Medium': '#f1c40f',
                'Low': '#27ae60'
            };
            return colors[severity] || '#95a5a6';
        }
        
        // Get severity radius
        function getSeverityRadius(severity) {
            const radii = {
                'Critical': 15,
                'High': 12,
                'Medium': 9,
                'Low': 6
            };
            return radii[severity] || 8;
        }
        
        // Update alerts
        function updateAlerts() {
            const alertsList = document.getElementById('alertsList');
            const criticalThreats = dashboardData.threats
                .filter(t => t.severity === 'Critical' || t.severity === 'High')
                .slice(0, 5);
            
            alertsList.innerHTML = criticalThreats.map(threat => `
                <div class="alert-item ${threat.severity.toLowerCase()}">
                    <div class="alert-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">${threat.type} - ${threat.severity}</div>
                        <div class="alert-time">${new Date(threat.timestamp).toLocaleString()}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Setup navigation
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    if (this.getAttribute('href').startsWith('#')) {
                        e.preventDefault();
                        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                    }
                });
            });
        }
        
        // Update dashboard based on filters
        function updateDashboard() {
            loadDashboardData();
        }
        
        // Initialize real-time monitoring
        function initializeRealTimeMonitoring() {
            // Initialize threat heatmap
            initializeThreatHeatmap();
            
            // Load initial real-time data
             updateRealTimeThreats();
             updateThreatAnalytics();
             updateSystemHealth();
             updateIncidentTimeline();
             
             // Load case management data
             updateCaseMetrics();
             updateInvestigationOutcomes();
             updatePerformanceAnalytics();
        }
        
        function updateRealTimeThreats() {
            fetch('/api/dashboard/realtime-threats')
                .then(response => response.json())
                .then(data => {
                    if (data.new_threats) {
                        displayNewThreats(data.new_threats);
                        updateThreatCounter(data.new_threats.length);
                    }
                })
                .catch(error => console.error('Error fetching real-time threats:', error));
        }
        
        function displayNewThreats(threats) {
            const threatFeed = document.getElementById('threat-feed');
            if (!threatFeed) return;
            
            threats.forEach(threat => {
                const threatElement = document.createElement('div');
                threatElement.className = `threat-item severity-${threat.severity.toLowerCase()}`;
                threatElement.innerHTML = `
                    <div class="threat-header">
                        <span class="threat-type">${threat.type}</span>
                        <span class="threat-severity ${threat.severity.toLowerCase()}">${threat.severity}</span>
                    </div>
                    <div class="threat-details">
                        <small>Source: ${threat.source_ip} | Target: ${threat.target}</small>
                        <small class="threat-time">${new Date(threat.timestamp).toLocaleTimeString()}</small>
                    </div>
                `;
                
                // Add to top of feed
                threatFeed.insertBefore(threatElement, threatFeed.firstChild);
                
                // Remove old items (keep only last 10)
                while (threatFeed.children.length > 10) {
                    threatFeed.removeChild(threatFeed.lastChild);
                }
                
                // Animate new threat
                threatElement.style.opacity = '0';
                threatElement.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    threatElement.style.transition = 'all 0.3s ease';
                    threatElement.style.opacity = '1';
                    threatElement.style.transform = 'translateY(0)';
                }, 100);
            });
        }
        
        function updateThreatCounter(newThreats) {
            const counter = document.getElementById('threat-counter');
            if (counter) {
                const current = parseInt(counter.textContent) || 0;
                counter.textContent = current + newThreats;
                
                // Flash animation
                counter.style.animation = 'flash 0.5s ease';
                setTimeout(() => counter.style.animation = '', 500);
            }
        }
        
        function updateThreatAnalytics() {
            fetch('/api/dashboard/threat-analytics')
                .then(response => response.json())
                .then(data => {
                    updateHourlyThreatChart(data.hourly_threats);
                    updateSeverityDistribution(data.severity_distribution);
                    updateAttackVectorChart(data.top_attack_vectors);
                    updateGeographicHeatmap(data.geographic_distribution);
                })
                .catch(error => console.error('Error fetching threat analytics:', error));
        }
        
        function updateSystemHealth() {
            fetch('/api/dashboard/system-health')
                .then(response => response.json())
                .then(data => {
                    updateHealthMetrics(data);
                })
                .catch(error => console.error('Error fetching system health:', error));
        }
        
        function updateIncidentTimeline() {
            fetch('/api/dashboard/incident-timeline')
                .then(response => response.json())
                .then(data => {
                    displayIncidentTimeline(data.incidents);
                })
                .catch(error => console.error('Error fetching incident timeline:', error));
        }
        
        function initializeThreatHeatmap() {
            // Initialize world map for threat visualization
            if (typeof L !== 'undefined') {
                const map = L.map('threat-heatmap').setView([20, 0], 2);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
                
                window.threatMap = map;
            }
        }
        
        function updateGeographicHeatmap(geoData) {
            if (!window.threatMap) return;
            
            // Clear existing markers
            window.threatMap.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    window.threatMap.removeLayer(layer);
                }
            });
            
            // Add threat markers
            const coordinates = {
                'United States': [39.8283, -98.5795],
                'China': [35.8617, 104.1954],
                'Russia': [61.5240, 105.3188],
                'Germany': [51.1657, 10.4515],
                'United Kingdom': [55.3781, -3.4360]
            };
            
            geoData.forEach(country => {
                const coords = coordinates[country.country];
                if (coords) {
                    const marker = L.circleMarker(coords, {
                        radius: Math.sqrt(country.threats) * 2,
                        fillColor: getThreatColor(country.threats),
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(window.threatMap);
                    
                    marker.bindPopup(`<b>${country.country}</b><br>Threats: ${country.threats}`);
                }
            });
        }
        
        function getThreatColor(threatCount) {
             if (threatCount > 80) return '#d32f2f';
             if (threatCount > 60) return '#f57c00';
             if (threatCount > 40) return '#fbc02d';
             return '#388e3c';
         }
         
         function updateHealthMetrics(healthData) {
             // Update CPU usage
             updateHealthBar('cpu', healthData.cpu_usage);
             
             // Update Memory usage
             updateHealthBar('memory', healthData.memory_usage);
             
             // Update Disk usage
             updateHealthBar('disk', healthData.disk_usage);
             
             // Update Network traffic
             updateHealthBar('network', healthData.network_traffic);
         }
         
         function updateHealthBar(type, value) {
             const bar = document.getElementById(`${type}-bar`);
             const valueElement = document.getElementById(`${type}-value`);
             
             if (bar && valueElement) {
                 bar.style.width = `${value}%`;
                 valueElement.textContent = `${value}%`;
                 
                 // Update color based on value
                 bar.className = 'health-progress';
                 if (value > 80) {
                     bar.classList.add('danger');
                 } else if (value > 60) {
                     bar.classList.add('warning');
                 }
             }
         }
         
         function displayIncidentTimeline(incidents) {
             const timeline = document.getElementById('incident-timeline');
             if (!timeline) return;
             
             timeline.innerHTML = '';
             
             incidents.forEach(incident => {
                 const incidentElement = document.createElement('div');
                 incidentElement.className = `incident-item ${incident.severity.toLowerCase()}`;
                 
                 const iconColor = {
                     'Critical': '#d32f2f',
                     'High': '#f57c00',
                     'Medium': '#fbc02d',
                     'Low': '#388e3c'
                 }[incident.severity] || '#666';
                 
                 const statusClass = incident.status.toLowerCase().replace(' ', '');
                 
                 incidentElement.innerHTML = `
                     <div class="incident-icon" style="background: ${iconColor};">⚠</div>
                     <div class="incident-content">
                         <div class="incident-title">${incident.id} - ${incident.type}</div>
                         <div class="incident-description">${incident.description}</div>
                         <div class="incident-meta">
                             <span>Assigned to: ${incident.assigned_to}</span>
                             <span class="incident-status ${statusClass}">${incident.status}</span>
                         </div>
                     </div>
                 `;
                 
                 timeline.appendChild(incidentElement);
             });
         }
         
         function updateHourlyThreatChart(hourlyData) {
             if (window.hourlyChart) {
                 window.hourlyChart.data.labels = hourlyData.map(d => d.hour);
                 window.hourlyChart.data.datasets[0].data = hourlyData.map(d => d.threats);
                 window.hourlyChart.update();
             }
         }
         
         function updateSeverityDistribution(severityData) {
             if (window.severityChart) {
                 window.severityChart.data.datasets[0].data = [
                     severityData.Critical,
                     severityData.High,
                     severityData.Medium,
                     severityData.Low
                 ];
                 window.severityChart.update();
             }
         }
         
         function updateAttackVectorChart(attackData) {
             if (window.attackChart) {
                 window.attackChart.data.labels = attackData.map(d => d.name);
                 window.attackChart.data.datasets[0].data = attackData.map(d => d.count);
                 window.attackChart.update();
             }
         }
         
         function updateCaseMetrics() {
             fetch('/api/dashboard/case-metrics')
                 .then(response => response.json())
                 .then(data => {
                     // Update metric cards
                     document.getElementById('total-cases').textContent = data.total_cases;
                     document.getElementById('active-cases').textContent = data.active_cases;
                     document.getElementById('resolved-cases').textContent = data.resolved_cases;
                     document.getElementById('completion-rate').textContent = data.case_completion_rate + '%';
                     
                     // Update case status chart
                     updateCaseStatusChart(data.case_status_distribution);
                     
                     // Update monthly trends chart
                     updateMonthlyTrendsChart(data.monthly_trends);
                 })
                 .catch(error => console.error('Error fetching case metrics:', error));
         }
         
         function updateCaseStatusChart(statusData) {
             const ctx = document.getElementById('case-status-chart');
             if (!ctx) return;
             
             if (window.caseStatusChart) {
                 window.caseStatusChart.destroy();
             }
             
             window.caseStatusChart = new Chart(ctx, {
                 type: 'doughnut',
                 data: {
                     labels: Object.keys(statusData),
                     datasets: [{
                         data: Object.values(statusData),
                         backgroundColor: [
                             '#4caf50',
                             '#2196f3',
                             '#ff9800',
                             '#f44336',
                             '#9c27b0'
                         ],
                         borderWidth: 2,
                         borderColor: '#fff'
                     }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         legend: {
                             position: 'bottom'
                         }
                     }
                 }
             });
         }
         
         function updateMonthlyTrendsChart(trendsData) {
             const ctx = document.getElementById('monthly-trends-chart');
             if (!ctx) return;
             
             if (window.monthlyTrendsChart) {
                 window.monthlyTrendsChart.destroy();
             }
             
             window.monthlyTrendsChart = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: trendsData.map(d => d.month),
                     datasets: [
                         {
                             label: 'New Cases',
                             data: trendsData.map(d => d.new_cases),
                             borderColor: '#2196f3',
                             backgroundColor: 'rgba(33, 150, 243, 0.1)',
                             tension: 0.4
                         },
                         {
                             label: 'Resolved Cases',
                             data: trendsData.map(d => d.resolved_cases),
                             borderColor: '#4caf50',
                             backgroundColor: 'rgba(76, 175, 80, 0.1)',
                             tension: 0.4
                         }
                     ]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         legend: {
                             position: 'top'
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true
                         }
                     }
                 }
             });
         }
         
         function updateInvestigationOutcomes() {
            fetch('/api/dashboard/investigation-outcomes')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data && typeof data === 'object') {
                        if (data.successful_investigations && data.successful_investigations.categories) {
                            updateResolutionTypesChart(data.successful_investigations.categories);
                        }
                        if (data.investigation_methods) {
                            updateInvestigationMethodsChart(data.investigation_methods);
                        }
                    }
                })
                .catch(error => {
                    console.error('Error fetching investigation outcomes:', error);
                    // Handle error gracefully - maybe show a message to user
                });
        }
         
         function updateResolutionTypesChart(resolutionData) {
            const ctx = document.getElementById('resolution-types-chart');
            if (!ctx || !resolutionData || typeof resolutionData !== 'object') return;
            
            if (window.resolutionChart) {
                window.resolutionChart.destroy();
            }
            
            window.resolutionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Object.keys(resolutionData),
                    datasets: [{
                        label: 'Cases',
                        data: Object.values(resolutionData),
                         backgroundColor: [
                             '#4caf50',
                             '#2196f3',
                             '#ff9800',
                             '#f44336',
                             '#9c27b0'
                         ]
                     }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         legend: {
                             display: false
                         }
                     },
                     scales: {
                         y: {
                             beginAtZero: true
                         }
                     }
                 }
             });
         }
         
         function updateInvestigationMethodsChart(methodsData) {
            const ctx = document.getElementById('investigation-methods-chart');
            if (!ctx || !methodsData || typeof methodsData !== 'object') return;
            
            if (window.methodsChart) {
                window.methodsChart.destroy();
            }
            
            window.methodsChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.keys(methodsData),
                    datasets: [{
                        label: 'Usage Count',
                        data: Object.values(methodsData),
                         backgroundColor: 'rgba(33, 150, 243, 0.2)',
                         borderColor: '#2196f3',
                         pointBackgroundColor: '#2196f3',
                         pointBorderColor: '#fff',
                         pointHoverBackgroundColor: '#fff',
                         pointHoverBorderColor: '#2196f3'
                     }]
                 },
                 options: {
                     responsive: true,
                     plugins: {
                         legend: {
                             display: false
                         }
                     },
                     scales: {
                         r: {
                             beginAtZero: true
                         }
                     }
                 }
             });
         }
         
         function updatePerformanceAnalytics() {
             fetch('/api/dashboard/performance-analytics')
                 .then(response => response.json())
                 .then(data => {
                     displayOfficerPerformance(data.officer_performance);
                     displayDepartmentMetrics(data.department_metrics);
                 })
                 .catch(error => console.error('Error fetching performance analytics:', error));
         }
         
         function displayOfficerPerformance(officers) {
             const container = document.getElementById('officer-performance');
             if (!container) return;
             
             container.innerHTML = '';
             
             officers.forEach(officer => {
                 const officerElement = document.createElement('div');
                 officerElement.className = 'officer-item';
                 officerElement.innerHTML = `
                     <div class="officer-name">${officer.name}</div>
                     <div class="officer-stats">
                         <div class="officer-stat">
                             <span>Cases Handled:</span>
                             <span>${officer.cases_handled}</span>
                         </div>
                         <div class="officer-stat">
                             <span>Success Rate:</span>
                             <span>${officer.success_rate}%</span>
                         </div>
                         <div class="officer-stat">
                             <span>Avg Resolution:</span>
                             <span>${officer.avg_resolution_time} days</span>
                         </div>
                         <div class="officer-stat">
                             <span>Specialization:</span>
                             <span>${officer.specialization}</span>
                         </div>
                     </div>
                 `;
                 container.appendChild(officerElement);
             });
         }
         
         function displayDepartmentMetrics(metrics) {
             const container = document.getElementById('department-metrics');
             if (!container) return;
             
             container.innerHTML = `
                 <div class="dept-stat-item">
                     <span class="dept-stat-label">Total Officers</span>
                     <span class="dept-stat-value">${metrics.total_officers}</span>
                 </div>
                 <div class="dept-stat-item">
                     <span class="dept-stat-label">Active Investigations</span>
                     <span class="dept-stat-value">${metrics.active_investigations}</span>
                 </div>
                 <div class="dept-stat-item">
                     <span class="dept-stat-label">Cases per Officer</span>
                     <span class="dept-stat-value">${metrics.cases_per_officer}</span>
                 </div>
                 <div class="dept-stat-item">
                     <span class="dept-stat-label">Department Efficiency</span>
                     <span class="dept-stat-value">${metrics.department_efficiency}%</span>
                 </div>
             `;
         }
        
        // Export report
        function exportReport() {
            const reportData = {
                timestamp: new Date().toISOString(),
                statistics: {
                    totalCriminals: document.getElementById('totalCriminals').textContent,
                    activeThreats: document.getElementById('activeThreats').textContent,
                    activeCases: document.getElementById('activeCases').textContent,
                    completionRate: document.getElementById('completionRate').textContent
                },
                threats: dashboardData.threats,
                cases: dashboardData.cases
            };
            
            const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cybersecurity_report_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // Advanced Filtering Functions
        let activeFilters = {};
        let drillDownData = {};
        
        function toggleAdvancedFilters() {
            const advancedFilters = document.getElementById('advanced-filters');
            const isVisible = advancedFilters.style.display !== 'none';
            advancedFilters.style.display = isVisible ? 'none' : 'block';
        }
        
        function applyFilters() {
            // Collect all filter values
            const filters = {
                timeRange: document.getElementById('time-range').value,
                threatType: document.getElementById('threat-type').value,
                severity: document.getElementById('severity-level').value,
                status: document.getElementById('case-status').value,
                region: document.getElementById('geographic-region').value,
                attackSource: document.getElementById('attack-source').value,
                officer: document.getElementById('assigned-officer').value,
                priority: document.getElementById('priority-level').value
            };
            
            // Handle custom date range
            if (filters.timeRange === 'custom') {
                filters.startDate = document.getElementById('start-date').value;
                filters.endDate = document.getElementById('end-date').value;
            }
            
            // Handle pattern recognition
            const patternOptions = document.querySelectorAll('input[name="pattern"]:checked');
            filters.patterns = Array.from(patternOptions).map(option => option.value);
            
            // Update active filters
            activeFilters = filters;
            updateActiveFiltersDisplay();
            
            // Apply filters to all dashboard components
            applyFiltersToData();
        }
        
        function clearFilters() {
            // Reset all filter inputs
            document.getElementById('time-range').value = '24h';
            document.getElementById('threat-type').value = 'all';
            document.getElementById('severity-level').value = 'all';
            document.getElementById('case-status').value = 'all';
            document.getElementById('geographic-region').value = 'all';
            document.getElementById('attack-source').value = 'all';
            document.getElementById('assigned-officer').value = 'all';
            document.getElementById('priority-level').value = 'all';
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            
            // Clear pattern recognition checkboxes
            document.querySelectorAll('input[name="pattern"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear active filters
            activeFilters = {};
            updateActiveFiltersDisplay();
            
            // Refresh all data
            refreshAllData();
        }
        
        function updateActiveFiltersDisplay() {
            const activeFiltersContainer = document.getElementById('active-filters');
            const filterTags = document.getElementById('filter-tags');
            
            if (Object.keys(activeFilters).length === 0) {
                activeFiltersContainer.style.display = 'none';
                return;
            }
            
            activeFiltersContainer.style.display = 'block';
            filterTags.innerHTML = '';
            
            Object.entries(activeFilters).forEach(([key, value]) => {
                if (value && value !== 'all' && value !== '') {
                    const tag = document.createElement('span');
                    tag.className = 'filter-tag';
                    tag.innerHTML = `${key}: ${value} <span class="remove" onclick="removeFilter('${key}')">&times;</span>`;
                    filterTags.appendChild(tag);
                }
            });
        }
        
        function removeFilter(filterKey) {
            delete activeFilters[filterKey];
            updateActiveFiltersDisplay();
            applyFiltersToData();
        }
        
        function applyFiltersToData() {
            // Apply filters to real-time threats
            updateRealTimeThreats();
            
            // Apply filters to analytics
            updateThreatAnalytics();
            
            // Apply filters to case metrics
            updateCaseMetrics();
            
            // Apply filters to performance analytics
            updatePerformanceAnalytics();
        }
        
        function refreshAllData() {
            // Refresh all dashboard components
            updateRealTimeThreats();
            updateThreatAnalytics();
            updateSystemHealth();
            updateIncidentTimeline();
            updateCaseMetrics();
            updateInvestigationOutcomes();
            updatePerformanceAnalytics();
        }
        
        // Drill-down Functions
        function enableDrillDown(chartElement, dataType) {
            chartElement.classList.add('clickable-chart');
            chartElement.addEventListener('click', function(event) {
                showDrillDownData(dataType, event);
            });
        }
        
        function showDrillDownData(dataType, event) {
            const drillDownContainer = document.getElementById('drill-down-container');
            const drillDownContent = document.getElementById('drill-down-content');
            
            // Show loading state
            drillDownContent.innerHTML = '<div class="loading">Loading detailed data...</div>';
            drillDownContainer.style.display = 'block';
            
            // Fetch drill-down data based on type
            fetchDrillDownData(dataType).then(data => {
                displayDrillDownData(data, dataType);
            });
        }
        
        async function fetchDrillDownData(dataType) {
            // Simulate API call for drill-down data
            const mockData = {
                threats: [
                    {
                        id: 'T001',
                        title: 'Suspicious Login Attempt',
                        severity: 'High',
                        source: '192.168.1.100',
                        target: 'Admin Portal',
                        timestamp: new Date().toISOString(),
                        details: 'Multiple failed login attempts detected'
                    },
                    {
                        id: 'T002',
                        title: 'Malware Detection',
                        severity: 'Critical',
                        source: 'External',
                        target: 'Workstation-05',
                        timestamp: new Date().toISOString(),
                        details: 'Trojan.Win32.Generic detected and quarantined'
                    }
                ],
                cases: [
                    {
                        id: 'C001',
                        title: 'Identity Theft Investigation',
                        status: 'Active',
                        officer: 'Detective Smith',
                        priority: 'High',
                        created: '2024-01-15',
                        details: 'Multiple victims reported identity theft'
                    },
                    {
                        id: 'C002',
                        title: 'Cyberbullying Case',
                        status: 'Under Review',
                        officer: 'Officer Johnson',
                        priority: 'Medium',
                        created: '2024-01-14',
                        details: 'Social media harassment investigation'
                    }
                ]
            };
            
            return mockData[dataType] || [];
        }
        
        function displayDrillDownData(data, dataType) {
            const drillDownContent = document.getElementById('drill-down-content');
            
            if (!data || data.length === 0) {
                drillDownContent.innerHTML = '<div class="no-data">No detailed data available</div>';
                return;
            }
            
            let html = '';
            data.forEach(item => {
                html += `
                    <div class="drill-down-item">
                        <div class="drill-down-title">${item.title}</div>
                        <div class="drill-down-details">
                            <div><strong>ID:</strong> ${item.id}</div>
                            <div><strong>Status:</strong> ${item.status || item.severity}</div>
                            <div><strong>Source:</strong> ${item.source || item.officer}</div>
                            <div><strong>Target:</strong> ${item.target || item.priority}</div>
                            <div><strong>Time:</strong> ${item.timestamp || item.created}</div>
                            <div><strong>Details:</strong> ${item.details}</div>
                        </div>
                    </div>
                `;
            });
            
            drillDownContent.innerHTML = html;
        }
        
        function closeDrillDown() {
            document.getElementById('drill-down-container').style.display = 'none';
        }
        
        // Pattern Recognition Functions
        function detectAnomalies() {
            // Simulate anomaly detection
            const anomalies = [
                { type: 'Unusual login pattern', severity: 'Medium', confidence: 0.85 },
                { type: 'Spike in failed authentications', severity: 'High', confidence: 0.92 },
                { type: 'Abnormal data transfer volume', severity: 'Low', confidence: 0.73 }
            ];
            
            displayAnomalies(anomalies);
        }
        
        function analyzeTrends() {
            // Simulate trend analysis
            const trends = [
                { metric: 'Threat Volume', trend: 'increasing', change: '+15%', period: '7 days' },
                { metric: 'Response Time', trend: 'decreasing', change: '-8%', period: '7 days' },
                { metric: 'Case Resolution', trend: 'stable', change: '+2%', period: '7 days' }
            ];
            
            displayTrends(trends);
        }
        
        function performCorrelationAnalysis() {
            // Simulate correlation analysis
            const correlations = [
                { factor1: 'Time of Day', factor2: 'Threat Severity', correlation: 0.67, significance: 'High' },
                { factor1: 'Geographic Location', factor2: 'Attack Type', correlation: 0.45, significance: 'Medium' },
                { factor1: 'User Role', factor2: 'Target Frequency', correlation: 0.78, significance: 'High' }
            ];
            
            displayCorrelations(correlations);
        }
        
        function displayAnomalies(anomalies) {
            console.log('Anomalies detected:', anomalies);
            // Add visual indicators for anomalies
            anomalies.forEach(anomaly => {
                if (anomaly.confidence > 0.8) {
                    // Add anomaly indicator to relevant dashboard elements
                    addAnomalyIndicator(anomaly.type);
                }
            });
        }
        
        function displayTrends(trends) {
            console.log('Trends analyzed:', trends);
            // Add trend indicators to dashboard
            trends.forEach(trend => {
                addTrendIndicator(trend.metric, trend.trend, trend.change);
            });
        }
        
        function displayCorrelations(correlations) {
            console.log('Correlations found:', correlations);
            // Display correlation insights
            correlations.forEach(correlation => {
                if (correlation.significance === 'High') {
                    console.log(`Strong correlation found: ${correlation.factor1} vs ${correlation.factor2}`);
                }
            });
        }
        
        function addAnomalyIndicator(type) {
            // Add visual anomaly indicators to relevant elements
            const elements = document.querySelectorAll('.metric-card, .chart-container');
            elements.forEach(element => {
                if (!element.classList.contains('anomaly-indicator')) {
                    element.classList.add('anomaly-indicator');
                }
            });
        }
        
        function addTrendIndicator(metric, trend, change) {
            // Add trend indicators to relevant metrics
            const trendClass = `trend-${trend}`;
            const trendIcon = trend === 'increasing' ? '↗' : trend === 'decreasing' ? '↘' : '→';
            
            // Find relevant metric elements and add trend indicators
            const metricElements = document.querySelectorAll('.metric-value');
            metricElements.forEach(element => {
                const trendSpan = document.createElement('span');
                trendSpan.className = `trend-indicator ${trendClass}`;
                trendSpan.innerHTML = `${trendIcon} ${change}`;
                element.appendChild(trendSpan);
            });
        }
        
        // Advanced features initialization is now handled in the main DOMContentLoaded event above
        
        // Alerts Functions
        function refreshAlerts() {
            fetch('/api/dashboard/alerts')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayAlerts(data.alerts);
                        document.getElementById('alerts-count').textContent = data.alerts.length;
                    }
                })
                .catch(error => {
                    console.error('Error fetching alerts:', error);
                    document.getElementById('alerts-container').innerHTML = '<div class="alert-error">Failed to load alerts</div>';
                });
        }
        
        function displayAlerts(alerts) {
            const container = document.getElementById('alerts-container');
            if (alerts.length === 0) {
                container.innerHTML = '<div class="no-alerts">No active alerts</div>';
                return;
            }
            
            const alertsHtml = alerts.map(alert => `
                <div class="alert-item severity-${alert.severity}">
                    <div class="alert-header">
                        <span class="alert-title">${alert.title}</span>
                        <span class="alert-time">${new Date(alert.created_at).toLocaleString()}</span>
                    </div>
                    <div class="alert-description">${alert.description}</div>
                    <div class="alert-actions">
                        <button class="btn btn-sm btn-success" onclick="acknowledgeAlert('${alert.id}')">Acknowledge</button>
                        <button class="btn btn-sm btn-info" onclick="viewAlertDetails('${alert.id}')">Details</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = alertsHtml;
        }
        
        function acknowledgeAlert(alertId) {
            fetch(`/api/dashboard/alerts/acknowledge`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ alert_id: alertId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    refreshAlerts();
                } else {
                    alert('Failed to acknowledge alert');
                }
            })
            .catch(error => {
                console.error('Error acknowledging alert:', error);
                alert('Error acknowledging alert');
            });
        }
        
        function showCreateAlert() {
            document.getElementById('create-alert-modal').style.display = 'block';
        }
        
        function closeCreateAlert() {
            document.getElementById('create-alert-modal').style.display = 'none';
            document.getElementById('create-alert-form').reset();
        }
        
        function createAlert() {
            const form = document.getElementById('create-alert-form');
            const formData = new FormData(form);
            
            const alertData = {
                title: formData.get('title'),
                description: formData.get('description'),
                severity: formData.get('severity'),
                category: formData.get('category')
            };
            
            fetch('/api/dashboard/alerts/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(alertData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeCreateAlert();
                    refreshAlerts();
                } else {
                    alert('Failed to create alert: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error creating alert:', error);
                alert('Error creating alert');
            });
        }
        
        function exportDashboard(type) {
              const url = `/api/dashboard/export/${type}`;
              window.open(url, '_blank');
          }
          
          // Chat System Functions
          let chatMode = 'single'; // 'single' or 'pair'
          let chatMessages = [];
          let currentUser = '{{ session.admin_username }}';
          let typingTimeout;
          
          function toggleChatMode() {
              const btn = document.getElementById('chat-mode-btn');
              if (chatMode === 'single') {
                  chatMode = 'pair';
                  btn.innerHTML = '<i class="fas fa-user"></i> Single Chat';
                  addSystemMessage('Switched to Pair Chat mode. You can now collaborate with team members.');
                  // Simulate adding a partner
                  addParticipant('Partner User', false);
              } else {
                  chatMode = 'single';
                  btn.innerHTML = '<i class="fas fa-users"></i> Pair Chat';
                  addSystemMessage('Switched to Single Chat mode.');
                  removeParticipant('Partner User');
              }
          }
          
          function addParticipant(username, isActive = true) {
              const participantsContainer = document.getElementById('chat-participants');
              const participant = document.createElement('div');
              participant.className = `participant ${isActive ? 'active' : ''}`;
              participant.setAttribute('data-user', username);
              participant.innerHTML = `<i class="fas fa-user"></i> ${username}`;
              participantsContainer.appendChild(participant);
          }
          
          function removeParticipant(username) {
              const participant = document.querySelector(`[data-user="${username}"]`);
              if (participant) {
                  participant.remove();
              }
          }
          
          function sendMessage() {
              const input = document.getElementById('chat-input');
              const message = input.value.trim();
              
              if (message) {
                  addMessage(currentUser, message, 'own');
                  input.value = '';
                  
                  // Simulate partner response in pair chat mode
                  if (chatMode === 'pair') {
                      setTimeout(() => {
                          simulatePartnerResponse(message);
                      }, 1000 + Math.random() * 2000);
                  }
              }
          }
          
          function addMessage(sender, content, type = 'other', messageType = 'normal') {
              const messagesContainer = document.getElementById('chat-messages');
              const messageDiv = document.createElement('div');
              messageDiv.className = `message ${type} ${messageType}`;
              
              const timestamp = new Date().toLocaleTimeString();
              messageDiv.innerHTML = `
                  <div class="message-header">${sender} - ${timestamp}</div>
                  <div class="message-content">${content}</div>
              `;
              
              messagesContainer.appendChild(messageDiv);
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
              
              chatMessages.push({
                  sender,
                  content,
                  timestamp: new Date(),
                  type: messageType
              });
          }
          
          function addSystemMessage(content) {
              const messagesContainer = document.getElementById('chat-messages');
              const messageDiv = document.createElement('div');
              messageDiv.className = 'system-message';
              messageDiv.innerHTML = `<i class="fas fa-info-circle"></i> ${content}`;
              messagesContainer.appendChild(messageDiv);
              messagesContainer.scrollTop = messagesContainer.scrollHeight;
          }
          
          function simulatePartnerResponse(originalMessage) {
              const responses = [
                  'Thanks for the update. I\'ll review the case details.',
                  'Acknowledged. Moving this to high priority.',
                  'I\'ve updated the case status. Please check the latest information.',
                  'Good catch! I\'ll investigate this further.',
                  'Case has been assigned to the investigation team.',
                  'Status confirmed. Updating the database now.',
                  'I\'ll coordinate with the field team on this.',
                  'Evidence has been processed. Case can proceed.'
              ];
              
              const response = responses[Math.floor(Math.random() * responses.length)];
              addMessage('Partner User', response, 'other');
          }
          
          function insertTemplate(templateType) {
              const input = document.getElementById('chat-input');
              let template = '';
              
              switch (templateType) {
                  case 'status-update':
                      template = '[STATUS UPDATE] Case #XXX: Status changed from [OLD_STATUS] to [NEW_STATUS]. Reason: [REASON]';
                      break;
                  case 'priority-alert':
                      template = '[PRIORITY ALERT] Case #XXX requires immediate attention. Issue: [DESCRIPTION]. Action needed: [ACTION]';
                      break;
              }
              
              input.value = template;
              input.focus();
          }
          
          function attachFile() {
              // Simulate file attachment
              const fileName = prompt('Enter file name to attach:');
              if (fileName) {
                  addMessage(currentUser, `📎 Attached file: ${fileName}`, 'own');
              }
          }
          
          function addReminder() {
              const reminderText = prompt('Enter reminder text:');
              const reminderTime = prompt('Enter reminder time (e.g., 2 hours, tomorrow):');
              
              if (reminderText && reminderTime) {
                  addSystemMessage(`⏰ Reminder set: "${reminderText}" for ${reminderTime}`);
              }
          }
          
          function clearChat() {
              if (confirm('Are you sure you want to clear the chat history?')) {
                  const messagesContainer = document.getElementById('chat-messages');
                  messagesContainer.innerHTML = `
                      <div class="system-message">
                          <i class="fas fa-info-circle"></i>
                          Chat cleared. Welcome to Case Status Overview Chat.
                      </div>
                  `;
                  chatMessages = [];
              }
          }
          
          function exportChatLog() {
              if (chatMessages.length === 0) {
                  alert('No messages to export.');
                  return;
              }
              
              let logContent = 'Case Status Overview Chat Log\n';
              logContent += '================================\n\n';
              
              chatMessages.forEach(msg => {
                  logContent += `[${msg.timestamp.toLocaleString()}] ${msg.sender}: ${msg.content}\n`;
              });
              
              const blob = new Blob([logContent], { type: 'text/plain' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = `chat-log-${new Date().toISOString().split('T')[0]}.txt`;
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
          }
          
          // Chat input event listeners
          document.addEventListener('DOMContentLoaded', function() {
              const chatInput = document.getElementById('chat-input');
              if (chatInput) {
                  chatInput.addEventListener('keypress', function(e) {
                      if (e.key === 'Enter') {
                          sendMessage();
                      }
                  });
                  
                  chatInput.addEventListener('input', function() {
                      // Show typing indicator for pair chat
                      if (chatMode === 'pair') {
                          showTypingIndicator();
                          clearTimeout(typingTimeout);
                          typingTimeout = setTimeout(hideTypingIndicator, 1000);
                      }
                  });
              }
          });
          
          function showTypingIndicator() {
              let indicator = document.querySelector('.typing-indicator');
              if (!indicator) {
                  indicator = document.createElement('div');
                  indicator.className = 'typing-indicator';
                  indicator.innerHTML = `${currentUser} is typing...`;
                  document.getElementById('chat-messages').appendChild(indicator);
              }
              indicator.classList.add('show');
          }
          
          function hideTypingIndicator() {
               const indicator = document.querySelector('.typing-indicator');
               if (indicator) {
                   indicator.classList.remove('show');
               }
           }
           
           // Advanced Features Functions
           let activityFeedPaused = false;
           let activityFeedInterval;
           
           function initializeAdvancedFeatures() {
               // Start activity feed updates
               activityFeedInterval = setInterval(updateActivityFeed, 30000); // Update every 30 seconds
               
               // Initialize analytics
               updateAnalytics();
           }
           
           function pauseActivityFeed() {
               const btn = document.getElementById('pause-feed-btn');
               if (activityFeedPaused) {
                   activityFeedPaused = false;
                   btn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                   activityFeedInterval = setInterval(updateActivityFeed, 30000);
               } else {
                   activityFeedPaused = true;
                   btn.innerHTML = '<i class="fas fa-play"></i> Resume';
                   clearInterval(activityFeedInterval);
               }
           }
           
           function clearActivityFeed() {
               if (confirm('Clear all activity feed items?')) {
                   document.getElementById('activity-list').innerHTML = '<div class="activity-item"><div class="activity-icon info"><i class="fas fa-info-circle"></i></div><div class="activity-content"><div class="activity-title">Activity feed cleared</div><div class="activity-time">Just now</div></div></div>';
               }
           }
           
           function updateActivityFeed() {
               if (activityFeedPaused) return;
               
               const activities = [
                   { type: 'success', icon: 'check', title: 'Case resolved successfully', time: 'Just now' },
                   { type: 'warning', icon: 'exclamation-triangle', title: 'High priority alert triggered', time: 'Just now' },
                   { type: 'info', icon: 'user-plus', title: 'New suspect added to database', time: 'Just now' },
                   { type: 'error', icon: 'times', title: 'System error detected', time: 'Just now' },
                   { type: 'info', icon: 'shield-alt', title: 'Security scan completed', time: 'Just now' }
               ];
               
               const randomActivity = activities[Math.floor(Math.random() * activities.length)];
               addActivityItem(randomActivity);
           }
           
           function addActivityItem(activity) {
               const activityList = document.getElementById('activity-list');
               const activityItem = document.createElement('div');
               activityItem.className = 'activity-item';
               activityItem.innerHTML = `
                   <div class="activity-icon ${activity.type}"><i class="fas fa-${activity.icon}"></i></div>
                   <div class="activity-content">
                       <div class="activity-title">${activity.title}</div>
                       <div class="activity-time">${activity.time}</div>
                   </div>
               `;
               
               activityList.insertBefore(activityItem, activityList.firstChild);
               
               // Keep only last 10 items
               const items = activityList.querySelectorAll('.activity-item');
               if (items.length > 10) {
                   items[items.length - 1].remove();
               }
           }
           
           function updateAnalytics() {
               const timeframe = document.getElementById('analytics-timeframe').value;
               
               // Simulate analytics updates based on timeframe
               const analytics = {
                   '24h': { responseTime: '2.3s', accuracy: '94.7%', threats: '87', resolution: '4.2h' },
                   '7d': { responseTime: '2.1s', accuracy: '95.2%', threats: '156', resolution: '3.8h' },
                   '30d': { responseTime: '2.5s', accuracy: '93.9%', threats: '423', resolution: '4.5h' },
                   '90d': { responseTime: '2.7s', accuracy: '92.8%', threats: '1247', resolution: '5.1h' }
               };
               
               const data = analytics[timeframe];
               document.getElementById('response-time').textContent = data.responseTime;
               document.getElementById('accuracy-rate').textContent = data.accuracy;
               document.getElementById('threat-prevention').textContent = data.threats;
               document.getElementById('case-resolution').textContent = data.resolution;
           }
           
           // Quick Actions Functions
           function triggerEmergencyAlert() {
               if (confirm('This will trigger an emergency alert to all connected systems. Continue?')) {
                   addActivityItem({ type: 'error', icon: 'exclamation-triangle', title: 'EMERGENCY ALERT TRIGGERED', time: 'Just now' });
                   alert('Emergency alert has been sent to all systems and personnel.');
               }
           }
           
           function generateReport() {
               const reportType = prompt('Select report type:\n1. Daily Summary\n2. Weekly Analysis\n3. Monthly Overview\n4. Custom Report\n\nEnter number (1-4):');
               if (reportType && reportType >= 1 && reportType <= 4) {
                   addActivityItem({ type: 'info', icon: 'file-alt', title: `Report generation started (Type ${reportType})`, time: 'Just now' });
                   setTimeout(() => {
                       addActivityItem({ type: 'success', icon: 'check', title: 'Report generated successfully', time: 'Just now' });
                   }, 3000);
               }
           }
           
           function backupData() {
               if (confirm('Start data backup process? This may take several minutes.')) {
                   addActivityItem({ type: 'info', icon: 'database', title: 'Data backup initiated', time: 'Just now' });
                   setTimeout(() => {
                       addActivityItem({ type: 'success', icon: 'check', title: 'Data backup completed successfully', time: 'Just now' });
                   }, 5000);
               }
           }
           
           function systemMaintenance() {
               const maintenanceType = prompt('Select maintenance type:\n1. Database Optimization\n2. Cache Cleanup\n3. Log Rotation\n4. System Health Check\n\nEnter number (1-4):');
               if (maintenanceType && maintenanceType >= 1 && maintenanceType <= 4) {
                   addActivityItem({ type: 'warning', icon: 'tools', title: `System maintenance started (Type ${maintenanceType})`, time: 'Just now' });
               }
           }
           
           function exportAllData() {
               const format = prompt('Select export format:\n1. CSV\n2. JSON\n3. XML\n4. PDF Report\n\nEnter number (1-4):');
               if (format && format >= 1 && format <= 4) {
                   const formats = ['', 'CSV', 'JSON', 'XML', 'PDF'];
                   addActivityItem({ type: 'info', icon: 'download', title: `Data export started (${formats[format]} format)`, time: 'Just now' });
               }
           }
           
           function scheduleTask() {
               const taskName = prompt('Enter task name:');
               const taskTime = prompt('Enter schedule time (e.g., 2 hours, tomorrow 9 AM):');
               
               if (taskName && taskTime) {
                   addActivityItem({ type: 'info', icon: 'calendar-plus', title: `Task scheduled: ${taskName} for ${taskTime}`, time: 'Just now' });
               }
           }
         
         function toggleExportMenu() {
             const menu = document.getElementById('export-menu');
             menu.classList.toggle('show');
         }
         
         // Close dropdown when clicking outside
          document.addEventListener('click', function(event) {
              const dropdown = document.querySelector('.export-dropdown');
              if (dropdown && !dropdown.contains(event.target)) {
                  document.getElementById('export-menu').classList.remove('show');
              }
          });
          
          // Mobile menu toggle function
           function toggleMobileMenu() {
               const sidebar = document.querySelector('.sidebar');
               const backdrop = document.querySelector('.mobile-backdrop');
               
               sidebar.classList.toggle('active');
               backdrop.classList.toggle('active');
           }
           
           // Close mobile menu function
           function closeMobileMenu() {
               const sidebar = document.querySelector('.sidebar');
               const backdrop = document.querySelector('.mobile-backdrop');
               
               sidebar.classList.remove('active');
               backdrop.classList.remove('active');
           }
           
           // Close mobile menu when clicking outside
           document.addEventListener('click', function(event) {
               const sidebar = document.querySelector('.sidebar');
               const toggleButton = document.querySelector('.mobile-menu-toggle');
               
               if (sidebar && !sidebar.contains(event.target) && !toggleButton.contains(event.target)) {
                   closeMobileMenu();
               }
           });
    </script>
    
    <!-- Create Alert Modal -->
    {% if has_permission('create_alerts') %}
    <div id="create-alert-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Security Alert</h3>
                <span class="close" onclick="closeCreateAlert()">&times;</span>
            </div>
            <form id="create-alert-form">
                <div class="form-group">
                    <label for="alert-title">Title</label>
                    <input type="text" id="alert-title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="alert-description">Description</label>
                    <textarea id="alert-description" name="description" required></textarea>
                </div>
                <div class="form-group">
                    <label for="alert-severity">Severity</label>
                    <select id="alert-severity" name="severity" required>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="alert-category">Category</label>
                    <select id="alert-category" name="category" required>
                        <option value="security">Security Breach</option>
                        <option value="system">System Alert</option>
                        <option value="performance">Performance Issue</option>
                        <option value="compliance">Compliance Violation</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-primary" onclick="createAlert()">Create Alert</button>
                    <button type="button" class="btn btn-secondary" onclick="closeCreateAlert()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</body>
</html>